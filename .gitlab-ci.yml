stages:
  - build&test
  - linter
  - test-publishing
  - test-publishing-test
  - publishing
  - version_tag
  - release

2.7-tests:
  stage: build&test
  before_script:
    - sudo chmod 777 -R $(find -name "*.pyc") .
  after_script:
    - sudo chmod 777 -R $(find -name "*.pyc") .
  script: 
    - mkdir -p Settings
    - echo "{\"AppSid\":\"$WordsAppSid\",\"AppKey\":\"$WordsAppKey\",\"BaseUrl\":\"$WordsBaseUrl\" }" > Settings/servercreds.json
    - docker run --rm -v $PWD:/opt/project -w=/opt/project python:2.7.15 bash scripts/test-unittest.sh
  tags:
    - awcloud-linux

3.7-tests:
  stage: build&test
  after_script:
    - sudo chmod 777 -R $(find -name "*.pyc") .
  script: 
    - mkdir -p Settings
    - echo "{\"AppSid\":\"$WordsAppSid\",\"AppKey\":\"$WordsAppKey\",\"BaseUrl\":\"$WordsBaseUrl\" }" > Settings/servercreds.json
    - docker run --rm -v $PWD:/opt/project -w=/opt/project python:3.7 bash scripts/test-unittest.sh
  tags:
    - awcloud-linux

linter:
  stage: linter
  tags: 
    - awcloud-linux
  script: 
    - docker run --rm -v $PWD:/opt/project -w=/opt/project python:3.7 bash scripts/linter.sh
  artifacts:
    paths:
      - 'lintResults.txt'

merge-to-testPackage:
  stage: publishing
  before_script:
    - $env:ORIGIN += 'https://{0}:{1}@git.auckland.dynabic.com/words-cloud/words-cloud-python.git' -f $env:GIT_CI_USER, $env:GIT_CI_PASS
  script: 
    - git checkout master
    - 'git remote set-url origin $env:ORIGIN'
    - git checkout testPackage
    - git reset --hard origin/testPackage
    - git merge --no-ff --allow-unrelated-histories origin/master
    - git diff --name-status
    - git push
  only: 
    - master
  tags: 
    - awcloud
  when: manual

publish-test:
  stage: test-publishing
  script:
    - docker run --rm -v $PWD:/opt/project -w=/opt/project python:2.7.15 bash scripts/test-publish.sh $PypiLogin $PypiPass
  only:
    - testPackage
  tags:
    - awcloud-linux

test-package:
  stage: test-publishing-test
  after_script:
    - sudo chmod 777 -R $(find -name "*.pyc") .
  script:
    - mkdir -p Settings
    - echo "{\"AppSid\":\"$WordsAppSid\",\"AppKey\":\"$WordsAppKey\",\"BaseUrl\":\"$WordsBaseUrl\" }" > Settings/servercreds.json  
    - docker run --rm -v $PWD:/opt/project -w=/opt/project python:3.7 bash scripts/test-package.sh $WordsAppSid $WordsAppKey $WordsBaseUrl
  tags: 
    - awcloud-linux
  artifacts:
    paths:
      - nosetests.xml
    reports:
      junit:
        - nosetests.xml
  only:
    - testPackage

publish to PyPi:
  stage: publishing
  only:
    - testPackage
  before_script:
    - sudo chmod 777 -R $(find -name "*.pyc") .
  script:
    - git reset --hard
    - docker run --rm -v $PWD:/opt/project -w=/opt/project python:2.7.15 bash scripts/publish.sh $PypiLogin $PypiPass
  tags: 
    - awcloud-linux

add version tag:
  stage: version_tag
  only:
    - testPackage
  before_script:
    - $env:ORIGIN += 'https://{0}:{1}@git.auckland.dynabic.com/words-cloud/words-cloud-python.git' -f $env:GIT_CI_USER, $env:GIT_CI_PASS
    - '$jsonString = ( New-Object System.Net.WebClient ).DownloadString("https://api.aspose.cloud/v4.0/words/swagger/spec")'
    - '$env:SDK_VERSION = ( ( ConvertFrom-Json -InputObject $jsonString ).info.version | Select-String -Pattern "^\d+\.\d+" ).Matches[0].Value'
  script: 
    -  'git remote set-url origin $env:ORIGIN'
    - git checkout testPackage
    - git reset --hard origin/testPackage
    - git tag -a $env:SDK_VERSION -m "version $env:SDK_VERSION"
    - 'git push $env:ORIGIN $env:SDK_VERSION'
  tags: 
    - awcloud

create_release:
  stage: release
  only:
    - testPackage
  before_script:
    - "$env:ORIGIN += 'https://{0}:{1}@git.auckland.dynabic.com/words-cloud/words-cloud-python.git' -f $env:GIT_CI_USER, $env:GIT_CI_PASS"
  script: 
    - git checkout testPackage
    - 'git remote set-url origin $env:ORIGIN'
    - git checkout release
    - git reset --hard origin/release
    - git merge --no-ff --allow-unrelated-histories origin/testPackage
    - git diff --name-status
    - git push
  tags:
    - awcloud
  when: manual
